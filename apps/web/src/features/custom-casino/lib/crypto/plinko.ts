// @ts-nocheck
import { type GameHelperFunctions } from './types'
import { qUnit } from '../vault/helpers'
import { DEFAULT_MAX_COUNT } from './constants'

const solRequire = (condition: boolean, message: string) => {
  if (!condition) {
    throw new Error(message)
  }
}

export enum PlinkoRiskSelection {
  Low = 0,
  Medium = 1,
  High = 2,
  Random = 3,
}

export interface IPlinkoSide {
  riskLevel: number
  rowCount: number
}

const isValidPlinkoSide = (side: IPlinkoSide) => {
  if (side.riskLevel < 0 || side.riskLevel > 2) {
    return false
  }
  if (side.rowCount < 8 || side.rowCount > 16) {
    return false
  }
  return true
}

export const getMaxCountForPlinko = (side: IPlinkoSide) => {
  const maxNumberForQPrecision = getMaxCountForPlinkoBasedOnQPrecision(side)
  const maxNumberForTxGasLimit = getMaxCountForPlinkoBasedOnTxGasLimit(side)
  return maxNumberForQPrecision < maxNumberForTxGasLimit ? maxNumberForQPrecision : (
      maxNumberForTxGasLimit
    )
}

const getMaxCountForPlinkoBasedOnQPrecision = (side: IPlinkoSide) => {
  const qArr = PlinkoProbabilitiesAndMultipliers.getProbabilitesForRowCount(side.rowCount)
  let minQ = qArr[0] * 2n
  for (let i = 1; i < qArr.length; ++i) {
    if (qArr[i] < minQ) {
      minQ = qArr[i]
    }
  }
  let i = BigInt(DEFAULT_MAX_COUNT)
  for (; i >= 1n; i--) {
    // Check limit related to representing with q and k
    if (minQ === undefined) return DEFAULT_MAX_COUNT // Since revealCount can be 0 as of data but there is no q to represent that probably of win for that condition, it would return undefined, in that case, return the default value
    if (minQ ** i / qUnit ** (i - 1n) > 0n) {
      break
    }
  }
  // when loop ends or breaks out, the i should be the max valid count for given prob
  return Number(i)
}

// So far, I have noticed that qk's length upper limit is something like this 683 < x < 686. So, if it qk's length is above 686, it cant be submitted and if it is 683, it can be submitted, not sure about 684 or 685
// Had to manually test out to see at which count they hit the gas limit for a tx, so these values are found manually by trying
const riskLevelToRowCountToMaxCountForTxGasLimit = {
  '0': {
    '8': 16, // +
    '9': 16, // +
    '10': 11, // +
    '11': 12, // +
    '12': 9, // +
    '13': 11, // +
    '14': 12, // +
    '15': 7, // +
    '16': 7, // +
  },
  '1': {
    '8': 10, // +
    '9': 10, // +
    '10': 9, // +
    '11': 7, // +
    '12': 6, // +
    '13': 5, // +
    '14': 5, // +
    '15': 5, // +
    '16': 4, // +
  },
  '2': {
    '8': 8, // +
    '9': 8, // +
    '10': 6, // +
    '11': 6, // +
    '12': 5, // +
    '13': 5, // +
    '14': 5, // +
    '15': 5, // +
    '16': 5, // +
  },
}

const getMaxCountForPlinkoBasedOnTxGasLimit = (side: IPlinkoSide) => {
  return (riskLevelToRowCountToMaxCountForTxGasLimit as any)[side.riskLevel][side.rowCount]
}

export const plinkoHelperFunctions: GameHelperFunctions<IPlinkoSide> = {
  isValidSide: isValidPlinkoSide,
  getMaxCount: getMaxCountForPlinko,
}

export class PlinkoProbabilitiesAndMultipliers {
  static getProbabilityForRowCountAndPosition = (rowCount: number, position: number) => {
    solRequire(
      rowCount >= 8 && rowCount <= 16,
      'Row count for Plinko has to be between 8 and 16 (inclusive)'
    )
    solRequire(
      position >= 0 && position <= rowCount,
      `Position has to be between 0 and rowCount (0 <= pos <= ${rowCount})`
    )
    return PlinkoProbabilitiesAndMultipliers.probabilities[rowCount - 8][position]
  }
  static getProbabilitesForRowCount = (rowCount: number) => {
    solRequire(
      rowCount >= 8 && rowCount <= 16,
      'Row count for Plinko has to be between 8 and 16 (inclusive)'
    )
    return PlinkoProbabilitiesAndMultipliers.probabilities[rowCount - 8]
  }
  //
  static getMultiplierForRiskLevelRowCountAndPosition = (
    riskLevel: number,
    rowCount: number,
    position: number
  ) => {
    solRequire(riskLevel >= 0 && riskLevel <= 2, 'Risk level has to be between 0 and 2 (inclusive)')
    solRequire(
      rowCount >= 8 && rowCount <= 16,
      'Row count for Plinko has to be between 8 and 16 (inclusive)'
    )
    solRequire(
      position >= 0 && position <= rowCount,
      `Position has to be between 0 and rowCount (0 <= pos <= ${rowCount})`
    )
    return PlinkoProbabilitiesAndMultipliers.multipliers[riskLevel][rowCount - 8][position]
  }
  static getMultipliersForRiskLevelAndRowCount = (riskLevel: number, rowCount: number) => {
    solRequire(riskLevel >= 0 && riskLevel <= 2, 'Risk level has to be between 0 and 2 (inclusive)')
    solRequire(
      rowCount >= 8 && rowCount <= 16,
      'Row count for Plinko has to be between 8 and 16 (inclusive)'
    )
    return PlinkoProbabilitiesAndMultipliers.multipliers[riskLevel][rowCount - 8]
  }
  static getMultipliersForRiskLevel = (riskLevel: number) => {
    solRequire(riskLevel >= 0 && riskLevel <= 2, 'Risk level has to be between 0 and 2 (inclusive)')
    return PlinkoProbabilitiesAndMultipliers.multipliers[riskLevel]
  }
  static probabilities = [
    [
      3906250000000000000000000000000000000000000000000000000000n,
      31250000000000000000000000000000000000000000000000000000000n,
      109375000000000000000000000000000000000000000000000000000000n,
      218750000000000000000000000000000000000000000000000000000000n,
      273437500000000000000000000000000000000000000000000000000000n,
      218750000000000000000000000000000000000000000000000000000000n,
      109375000000000000000000000000000000000000000000000000000000n,
      31250000000000000000000000000000000000000000000000000000000n,
      3906250000000000000000000000000000000000000000000000000000n,
    ],
    [
      1953125000000000000000000000000000000000000000000000000000n,
      17578125000000000000000000000000000000000000000000000000000n,
      70312500000000000000000000000000000000000000000000000000000n,
      164062500000000000000000000000000000000000000000000000000000n,
      246093750000000000000000000000000000000000000000000000000000n,
      246093750000000000000000000000000000000000000000000000000000n,
      164062500000000000000000000000000000000000000000000000000000n,
      70312500000000000000000000000000000000000000000000000000000n,
      17578125000000000000000000000000000000000000000000000000000n,
      1953125000000000000000000000000000000000000000000000000000n,
    ],
    [
      976562500000000000000000000000000000000000000000000000000n,
      9765625000000000000000000000000000000000000000000000000000n,
      43945312500000000000000000000000000000000000000000000000000n,
      117187500000000000000000000000000000000000000000000000000000n,
      205078125000000000000000000000000000000000000000000000000000n,
      246093750000000000000000000000000000000000000000000000000000n,
      205078125000000000000000000000000000000000000000000000000000n,
      117187500000000000000000000000000000000000000000000000000000n,
      43945312500000000000000000000000000000000000000000000000000n,
      9765625000000000000000000000000000000000000000000000000000n,
      976562500000000000000000000000000000000000000000000000000n,
    ],
    [
      488281250000000000000000000000000000000000000000000000000n,
      5371093750000000000000000000000000000000000000000000000000n,
      26855468750000000000000000000000000000000000000000000000000n,
      80566406250000000000000000000000000000000000000000000000000n,
      161132812500000000000000000000000000000000000000000000000000n,
      225585937500000000000000000000000000000000000000000000000000n,
      225585937500000000000000000000000000000000000000000000000000n,
      161132812500000000000000000000000000000000000000000000000000n,
      80566406250000000000000000000000000000000000000000000000000n,
      26855468750000000000000000000000000000000000000000000000000n,
      5371093750000000000000000000000000000000000000000000000000n,
      488281250000000000000000000000000000000000000000000000000n,
    ],
    [
      244140625000000000000000000000000000000000000000000000000n,
      2929687500000000000000000000000000000000000000000000000000n,
      16113281250000000000000000000000000000000000000000000000000n,
      53710937500000000000000000000000000000000000000000000000000n,
      120849609375000000000000000000000000000000000000000000000000n,
      193359375000000000000000000000000000000000000000000000000000n,
      225585937500000000000000000000000000000000000000000000000000n,
      193359375000000000000000000000000000000000000000000000000000n,
      120849609375000000000000000000000000000000000000000000000000n,
      53710937500000000000000000000000000000000000000000000000000n,
      16113281250000000000000000000000000000000000000000000000000n,
      2929687500000000000000000000000000000000000000000000000000n,
      244140625000000000000000000000000000000000000000000000000n,
    ],
    [
      122070312500000000000000000000000000000000000000000000000n,
      1586914062500000000000000000000000000000000000000000000000n,
      9521484375000000000000000000000000000000000000000000000000n,
      34912109375000000000000000000000000000000000000000000000000n,
      87280273437500000000000000000000000000000000000000000000000n,
      157104492187500000000000000000000000000000000000000000000000n,
      209472656250000000000000000000000000000000000000000000000000n,
      209472656250000000000000000000000000000000000000000000000000n,
      157104492187500000000000000000000000000000000000000000000000n,
      87280273437500000000000000000000000000000000000000000000000n,
      34912109375000000000000000000000000000000000000000000000000n,
      9521484375000000000000000000000000000000000000000000000000n,
      1586914062500000000000000000000000000000000000000000000000n,
      122070312500000000000000000000000000000000000000000000000n,
    ],
    [
      61035156250000000000000000000000000000000000000000000000n,
      854492187500000000000000000000000000000000000000000000000n,
      5554199218750000000000000000000000000000000000000000000000n,
      22216796875000000000000000000000000000000000000000000000000n,
      61096191406250000000000000000000000000000000000000000000000n,
      122192382812500000000000000000000000000000000000000000000000n,
      183288574218750000000000000000000000000000000000000000000000n,
      209472656250000000000000000000000000000000000000000000000000n,
      183288574218750000000000000000000000000000000000000000000000n,
      122192382812500000000000000000000000000000000000000000000000n,
      61096191406250000000000000000000000000000000000000000000000n,
      22216796875000000000000000000000000000000000000000000000000n,
      5554199218750000000000000000000000000000000000000000000000n,
      854492187500000000000000000000000000000000000000000000000n,
      61035156250000000000000000000000000000000000000000000000n,
    ],
    [
      30517578125000000000000000000000000000000000000000000000n,
      457763671875000000000000000000000000000000000000000000000n,
      3204345703125000000000000000000000000000000000000000000000n,
      13885498046875000000000000000000000000000000000000000000000n,
      41656494140625000000000000000000000000000000000000000000000n,
      91644287109375000000000000000000000000000000000000000000000n,
      152740478515625000000000000000000000000000000000000000000000n,
      196380615234375000000000000000000000000000000000000000000000n,
      196380615234375000000000000000000000000000000000000000000000n,
      152740478515625000000000000000000000000000000000000000000000n,
      91644287109375000000000000000000000000000000000000000000000n,
      41656494140625000000000000000000000000000000000000000000000n,
      13885498046875000000000000000000000000000000000000000000000n,
      3204345703125000000000000000000000000000000000000000000000n,
      457763671875000000000000000000000000000000000000000000000n,
      30517578125000000000000000000000000000000000000000000000n,
    ],
    [
      15258789062500000000000000000000000000000000000000000000n,
      244140625000000000000000000000000000000000000000000000000n,
      1831054687500000000000000000000000000000000000000000000000n,
      8544921875000000000000000000000000000000000000000000000000n,
      27770996093750000000000000000000000000000000000000000000000n,
      66650390625000000000000000000000000000000000000000000000000n,
      122192382812500000000000000000000000000000000000000000000000n,
      174560546875000000000000000000000000000000000000000000000000n,
      196380615234375000000000000000000000000000000000000000000000n,
      174560546875000000000000000000000000000000000000000000000000n,
      122192382812500000000000000000000000000000000000000000000000n,
      66650390625000000000000000000000000000000000000000000000000n,
      27770996093750000000000000000000000000000000000000000000000n,
      8544921875000000000000000000000000000000000000000000000000n,
      1831054687500000000000000000000000000000000000000000000000n,
      244140625000000000000000000000000000000000000000000000000n,
      15258789062500000000000000000000000000000000000000000000n,
    ],
  ]
  static multipliers = [
    [
      [
        5600000000000000000n,
        2100000000000000000n,
        1100000000000000000n,
        1000000000000000000n,
        500000000000000000n,
        1000000000000000000n,
        1100000000000000000n,
        2100000000000000000n,
        5600000000000000000n,
      ],
      [
        5600000000000000000n,
        2000000000000000000n,
        1600000000000000000n,
        1000000000000000000n,
        700000000000000000n,
        700000000000000000n,
        1000000000000000000n,
        1600000000000000000n,
        2000000000000000000n,
        5600000000000000000n,
      ],
      [
        8800000000000000000n,
        3000000000000000000n,
        1400000000000000000n,
        1100000000000000000n,
        1000000000000000000n,
        500000000000000000n,
        1000000000000000000n,
        1100000000000000000n,
        1400000000000000000n,
        3000000000000000000n,
        8800000000000000000n,
      ],
      [
        8300000000000000000n,
        3000000000000000000n,
        1900000000000000000n,
        1300000000000000000n,
        1000000000000000000n,
        700000000000000000n,
        700000000000000000n,
        1000000000000000000n,
        1300000000000000000n,
        1900000000000000000n,
        3000000000000000000n,
        8300000000000000000n,
      ],
      [
        10000000000000000000n,
        3000000000000000000n,
        1600000000000000000n,
        1400000000000000000n,
        1100000000000000000n,
        1000000000000000000n,
        500000000000000000n,
        1000000000000000000n,
        1100000000000000000n,
        1400000000000000000n,
        1600000000000000000n,
        3000000000000000000n,
        10000000000000000000n,
      ],
      [
        8100000000000000000n,
        4000000000000000000n,
        3000000000000000000n,
        1900000000000000000n,
        1200000000000000000n,
        900000000000000000n,
        700000000000000000n,
        700000000000000000n,
        900000000000000000n,
        1200000000000000000n,
        1900000000000000000n,
        3000000000000000000n,
        4000000000000000000n,
        8100000000000000000n,
      ],
      [
        7000000000000000000n,
        4000000000000000000n,
        1900000000000000000n,
        1400000000000000000n,
        1300000000000000000n,
        1100000000000000000n,
        1000000000000000000n,
        500000000000000000n,
        1000000000000000000n,
        1100000000000000000n,
        1300000000000000000n,
        1400000000000000000n,
        1900000000000000000n,
        4000000000000000000n,
        7000000000000000000n,
      ],
      [
        14000000000000000000n,
        8000000000000000000n,
        3000000000000000000n,
        2000000000000000000n,
        1500000000000000000n,
        1100000000000000000n,
        1000000000000000000n,
        700000000000000000n,
        700000000000000000n,
        1000000000000000000n,
        1100000000000000000n,
        1500000000000000000n,
        2000000000000000000n,
        3000000000000000000n,
        8000000000000000000n,
        14000000000000000000n,
      ],
      [
        16000000000000000000n,
        9000000000000000000n,
        2000000000000000000n,
        1400000000000000000n,
        1400000000000000000n,
        1200000000000000000n,
        1100000000000000000n,
        1000000000000000000n,
        500000000000000000n,
        1000000000000000000n,
        1100000000000000000n,
        1200000000000000000n,
        1400000000000000000n,
        1400000000000000000n,
        2000000000000000000n,
        9000000000000000000n,
        16000000000000000000n,
      ],
    ],
    [
      [
        13000000000000000000n,
        3000000000000000000n,
        1300000000000000000n,
        700000000000000000n,
        400000000000000000n,
        700000000000000000n,
        1300000000000000000n,
        3000000000000000000n,
        13000000000000000000n,
      ],
      [
        18000000000000000000n,
        3950000000000000000n,
        1700000000000000000n,
        900000000000000000n,
        500000000000000000n,
        500000000000000000n,
        900000000000000000n,
        1700000000000000000n,
        3950000000000000000n,
        18000000000000000000n,
      ],
      [
        22000000000000000000n,
        5000000000000000000n,
        2000000000000000000n,
        1400000000000000000n,
        600000000000000000n,
        400000000000000000n,
        600000000000000000n,
        1400000000000000000n,
        2000000000000000000n,
        5000000000000000000n,
        22000000000000000000n,
      ],
      [
        23000000000000000000n,
        6000000000000000000n,
        3000000000000000000n,
        1800000000000000000n,
        700000000000000000n,
        500000000000000000n,
        500000000000000000n,
        700000000000000000n,
        1800000000000000000n,
        3000000000000000000n,
        6000000000000000000n,
        23000000000000000000n,
      ],
      [
        33000000000000000000n,
        11000000000000000000n,
        4000000000000000000n,
        2000000000000000000n,
        1100000000000000000n,
        600000000000000000n,
        300000000000000000n,
        600000000000000000n,
        1100000000000000000n,
        2000000000000000000n,
        4000000000000000000n,
        11000000000000000000n,
        33000000000000000000n,
      ],
      [
        43000000000000000000n,
        13000000000000000000n,
        6000000000000000000n,
        3000000000000000000n,
        1300000000000000000n,
        700000000000000000n,
        400000000000000000n,
        400000000000000000n,
        700000000000000000n,
        1300000000000000000n,
        3000000000000000000n,
        6000000000000000000n,
        13000000000000000000n,
        43000000000000000000n,
      ],
      [
        58000000000000000000n,
        15000000000000000000n,
        7000000000000000000n,
        4000000000000000000n,
        1900000000000000000n,
        1000000000000000000n,
        500000000000000000n,
        200000000000000000n,
        500000000000000000n,
        1000000000000000000n,
        1900000000000000000n,
        4000000000000000000n,
        7000000000000000000n,
        15000000000000000000n,
        58000000000000000000n,
      ],
      [
        88000000000000000000n,
        18000000000000000000n,
        11000000000000000000n,
        5000000000000000000n,
        3000000000000000000n,
        1300000000000000000n,
        500000000000000000n,
        300000000000000000n,
        300000000000000000n,
        500000000000000000n,
        1300000000000000000n,
        3000000000000000000n,
        5000000000000000000n,
        11000000000000000000n,
        18000000000000000000n,
        88000000000000000000n,
      ],
      [
        110000000000000000000n,
        41000000000000000000n,
        10000000000000000000n,
        5000000000000000000n,
        3000000000000000000n,
        1500000000000000000n,
        1000000000000000000n,
        500000000000000000n,
        300000000000000000n,
        500000000000000000n,
        1000000000000000000n,
        1500000000000000000n,
        3000000000000000000n,
        5000000000000000000n,
        10000000000000000000n,
        41000000000000000000n,
        110000000000000000000n,
      ],
    ],
    [
      [
        29000000000000000000n,
        4000000000000000000n,
        1500000000000000000n,
        300000000000000000n,
        197000000000000000n,
        300000000000000000n,
        1500000000000000000n,
        4000000000000000000n,
        29000000000000000000n,
      ],
      [
        43000000000000000000n,
        7000000000000000000n,
        2000000000000000000n,
        600000000000000000n,
        198000000000000000n,
        198000000000000000n,
        600000000000000000n,
        2000000000000000000n,
        7000000000000000000n,
        43000000000000000000n,
      ],
      [
        76000000000000000000n,
        10000000000000000000n,
        3000000000000000000n,
        900000000000000000n,
        300000000000000000n,
        197000000000000000n,
        300000000000000000n,
        900000000000000000n,
        3000000000000000000n,
        10000000000000000000n,
        76000000000000000000n,
      ],
      [
        120000000000000000000n,
        14000000000000000000n,
        5200000000000000000n,
        1400000000000000000n,
        400000000000000000n,
        196000000000000000n,
        196000000000000000n,
        400000000000000000n,
        1400000000000000000n,
        5200000000000000000n,
        14000000000000000000n,
        120000000000000000000n,
      ],
      [
        170000000000000000000n,
        24000000000000000000n,
        8100000000000000000n,
        2000000000000000000n,
        700000000000000000n,
        200000000000000000n,
        196000000000000000n,
        196000000000000000n,
        700000000000000000n,
        2000000000000000000n,
        8100000000000000000n,
        24000000000000000000n,
        170000000000000000000n,
      ],
      [
        260000000000000000000n,
        37000000000000000000n,
        11000000000000000000n,
        4000000000000000000n,
        1000000000000000000n,
        198000000000000000n,
        199000000000000000n,
        199000000000000000n,
        198000000000000000n,
        1000000000000000000n,
        4000000000000000000n,
        11000000000000000000n,
        37000000000000000000n,
        260000000000000000000n,
      ],
      [
        420000000000000000000n,
        56000000000000000000n,
        18000000000000000000n,
        5000000000000000000n,
        1900000000000000000n,
        300000000000000000n,
        200000000000000000n,
        200000000000000000n,
        200000000000000000n,
        300000000000000000n,
        1900000000000000000n,
        5000000000000000000n,
        18000000000000000000n,
        56000000000000000000n,
        420000000000000000000n,
      ],
      [
        620000000000000000000n,
        83000000000000000000n,
        27000000000000000000n,
        8000000000000000000n,
        3000000000000000000n,
        500000000000000000n,
        199000000000000000n,
        199000000000000000n,
        199000000000000000n,
        199000000000000000n,
        500000000000000000n,
        3000000000000000000n,
        8000000000000000000n,
        27000000000000000000n,
        83000000000000000000n,
        620000000000000000000n,
      ],
      [
        1000000000000000000000n,
        130000000000000000000n,
        26000000000000000000n,
        9000000000000000000n,
        4000000000000000000n,
        2000000000000000000n,
        200000000000000000n,
        200000000000000000n,
        200000000000000000n,
        200000000000000000n,
        200000000000000000n,
        2000000000000000000n,
        4000000000000000000n,
        9000000000000000000n,
        26000000000000000000n,
        130000000000000000000n,
        1000000000000000000000n,
      ],
    ],
  ]
}
